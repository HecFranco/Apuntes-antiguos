PHP - Introducción
=========================
INDICE
------
14. [SUBIDA DE ARCHIVOS]()
  1. Generalidades

----------------------------------

14.Clase Subida de archivos al servidor
=======================================

14.1. Generalidades
-------------------

* **`$_FILES`** se trata de un array que muestra información sobre la subida del archivo entre ellos los errores `$_FILES['nombrearchivo']['error']`
* `**$_SERVER['PHP_SELF']**` El nombre del archivo de script ejecutándose actualmente, relativa al directorio raíz de documentos del servidor. Por ejemplo, el valor de `$_SERVER['PHP_SELF']` en un script ejecutado en la dirección **http://example.com/foo/bar.php** será **/foo/bar.php**. La constante `__FILE__` contiene la ruta completa del fichero actual, incluyendo el nombre del archivo. Si PHP se está ejecutando como un proceso de línea de comando, esta variable es el nombre del script desde PHP 4.3.0. En anteriores versiones no estaba disponible.
* Indicamos que tipo de archivos subiremos usando `**enctype="multipart/form-data"**` dentro de `<form></form>`

| **index.php** |
|---------------|

```php
<?php
$carpeta = "subidas/";
$mensaje = "";
if (isset($_POST['subir'])){
  /* 
  //  Veremos la información de la variable $_FILES que subira el archivo
  echo '<pre>';
  print_r ($_FILES);
  echo '</pre>';
  */
  switch($_FILES['nombrearchivo']['error']){
      case 0: 
         echo "Su archivo se ha subido correctamente";
        break;
      case 2:
        echo $_FILES['nombrearchivo']['name']." es demasiado grande"; 
        break;
      case 4:
        echo "No se ha selecionado un archivo"; 
        break;
      case 7:
        echo "No tiene permisos suficientes para subir el archivo"; 
        break;
      default:
        echo $_FILES['nombrearchivo']['name']." no se ha podido subir";   
   }
}
?>
<!DOCTYPE html>
<html>
  <head>
    <title>Subir archivos</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  </head>
  <body>
<!-- Indicamos que tipo de archivos subiremos usando enctype="multipart/form-data"-->
    <form action="<?php 
                    // Indicamos que debe ejecutarse en este mismo documento
                    echo $_SERVER['PHP_SELF']; 
                    ?>"
          method="post"
          enctype="multipart/form-data">
          <!-- 
          Limitamos el tamaño máximo de envío del archivo del formulario, y lo ocultamos. 
          El valor se limitan en bytes  value="10000"
          -->
          <input type="hidden" name="MAX_FILE_SIZE" value="10000">
          <label for="nombrearchivo">Selecione su archivo</label>
          <input type="file" name="nombrearchivo" id="nombrearchivo">
          <input type="submit" name="subir" value="Subir archivo">
    </form>
  </body>
</html>
```

| **info.php** |
|--------------|

```php
<?php
// Para ver la información del php.ini ejecutamos la funcion phpinfo()
// https://php.net/manual/es/ini.core.php
phpinfo();
```

| **.htaccess** |
|---------------|

```php
# REESCRIBIR LA CONFIGURACIÓN SERVIDOR APACHE PHP.INI
# .htaccess Para modificar los límites establecidos dentro del servidor Apache en php.ini accedemos a .htaccess
# El tamaño máximo de un fichero subido. Cuando se usa un integer, el valor del mismo es medido en bytes. También se puede usar la notación reducida, tal como se describe en esta FAQ.
php_value upload_max_filesize 000000000

# Modificar el tiempo máximo dedicado a cada subida de archivos
# php_value max_input_time 60

# Si permitir o no la subida de ficheros mediante HTTP. Véanse también las directivas upload_max_filesize, upload_tmp_dir, y post_max_size.
php_value file_uploads 1

# El directorio temporal usado para almacenar ficheros durante el proceso de subida. Es necesario tener permisos de escritura para el usuario que está ejecutando PHP. Si no está especificado, PHP usará el predeterminado del sistema. Si el directorio especificado no tiene permisos de escritura, PHP recurrirá al directorio temporal predeterminado del sistema. Si la directiva open_basedir está activada, al directorio predeterminado del sistema se le ha de permitir la subida de ficheros para que funcione.
# php_value upload_tmp_dir c:/wamp64/tmp
```

----------------------------------

A continuación se creará un archivo **UploaderClass.php** el cual gestionará la lógica de subida de los archivos.

----------------------------------

| **index.php** |
|---------------|

```php
<?php
// ini_get("upload_max_filesize") muestra el tamaño de archivo máximo a subir permitido por apache dentro de php.ini
// echo ini_get("upload_max_filesize"); 
$carpeta="subidas/";
$size=1000000000;
//definimos el posible mensaje de error
$mensaje="";
//comprobamos si se ha enviado el formulario
if(isset($_POST['subir']){
  // var_dump($_FILES);
  // var_dump(current($_FILES));
  require_once 'UploaderClass.php';
  try{
    $subir=new UploaderClass($carpeta);
    $subir->doUpload();
  }catch (Exception $ex){
    $mensaje=$e->getMessage();
  }
}
?>
<!DOCTYPE html>
<html>
  <head>
    <title>Subir archivos</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  </head>
  <body>
    <form action="<?php echo $_SERVER['PHP_SELF']; ?>"
          method="post"
          enctype="multipart/form-data">
          <!-- Limitamos el tamaño máximo de envío del archivo del formulario, y lo ocultamos. 
          El valor se limitan en bytes -->
          <input type="hidden" name="MAX_FILE_SIZE" value="<?php echo $size; ?>">
          <label for="nombrearchivo">Selecione su archivo</label>
          <input type="file" name="nombrearchivo" id="nombrearchivo">
          <input type="submit" name="subir" value="Subir archivo">
    </form>
    <?php
    //en caso de existir $mensaje lo imprimimos para mostrarlo.
      if($mensaje){echo $mensaje;}
    ?>
  </body>
</html>
```

* **.htaccess** Para modificar los límites establecidos dentro del servidor Apache en **php.ini** accedemos a **.htaccess**

| **.htaccess** |
|---------------|


```php
# ampliar el límite de tamaño de subida de los archivos
php_value upload_max_filesize 000000000
```

| **UploaderClass.php** |
|-----------------------|


```php
<?php
class UploaderClass{
  public function __construct($carpeta){
    // comprobamos si la carpeta de subida existe
    if(!files_exists($carpeta)){
      throw new Exception("No hay carpeta de subida");
    }
  }
  public function doUpload(){
    $archivo=current($_FILES);
    if(!this->serverTop($archivo)){
      return false;
    }
    if($this->checkFiles($archivo){
      $this->moveFiles(archivo);
    }
  }
  protected function serverTop($archivo){
    $maxFileSize=ini_get("upload_max_filesize");
    $serverLimit=self::getinBytes($maxFileSize);
    if($serverLimit > $archivo['size']){
      //mostramos el límite de tamaño de subida del servidor
      // echo $serverLimit; 
      return true;
    }else{
      echo "El servidor ha bloqueado la subida";
    }
  }
  protected function checkFiles($archivo){
    if($archivo['error']==0){
      return true;    
    }else{
      $this->errors($archivo);
      return false;
    }
  }
  protected function errors($archivo){
  // https:// php.net/manual/es/features.file-upload.errors.php
    switch($archivo['error']){
      case 0: 
         echo "Su archivo se ha subido correctamente";
        break;
      case 2:
        echo $archivo['name']." es demasiado grande"; 
        break;
      case 4:
        echo "No se ha selecionado un archivo"; 
        break;
      case 7:
        echo "No tiene permisos suficientes para subir el archivo"; 
        break;
      default:
        echo $archivo['name']." no se ha podido subir";   
    }
  }
  protected function moveFiles($archivo){
    echo $archivo['name'].' se ha subido';
  }
  protected function getInBytes ($serverMb){
    $serverMb = $serverMb * 1024 * 1024;
    return $serverMb;
  }
}

```

```php
echo '<pre>';
  print_r($_FILES); // $_FILES se trata de un array que muestra información sobre la subida del archivo entre ellos los errores ['error'];
  echo '</pre>';
  // observamos la información que se nos devuelve a través de la variable $_FILES para obtener información sobre los posibles valores de $_FILES['nombrearchivo']['error']
  
```
