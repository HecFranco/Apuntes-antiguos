3.FORMULARIOS 
===============

Dentro de la documentación de [**DOC Symfony 3 Formularios**](https://symfony.com/doc/current/forms.html) es interesante utilizar para formularios la clase dedicada Formulario.

3.1.Clase Formularios
---------------------

Se recomienda realizar una [clase específica de formulario](http://symfony.com/doc/current/forms.html#form-creating-form-classes), lo que nos ayudará a reutilizar el formulario. Para ello:
* Creamos una carpeta dentro de nuestro **Bundle** que se llamará **Form**, tal que así `src\Pixelpro\MisCursosBundle\Form` (Usaremos *CamelCase* para nombrar las carpetas).
* Dentro de `src\Pixelpro\MisCursosBundle\Form` crearemos los **task**, que son las tareas del formulario, mediante el archivo `src\Pixelpro\MisCursosBundle\Form\CursosType.php`.

El ejemplo de clase que marca la documentación es el siguiente:

```php
// src/AppBundle/Form/TaskType.php
namespace AppBundle\Form;

use Symfony\Component\Form\AbstractType;
use Symfony\Component\Form\FormBuilderInterface;
use Symfony\Component\Form\Extension\Core\Type\SubmitType;

class TaskType extends AbstractType
{
    public function buildForm(FormBuilderInterface $builder, array $options)
    {
        $builder
            ->add('task')
            ->add('dueDate', null, array('widget' => 'single_text'))
            ->add('save', SubmitType::class)
        ;
    }
}
```

Así para nuestro caso, será:

| src\Pixelpro\MisCursosBundle\Form\CursosType.php | 
|--------------------------------------------------|

```php
<?php
namespace Pixelpro\MisCursosBundel\Form;

// Nos permite construir un formulario
use Symfony\Component\Form\AbstractType;
// Creará la forma
use Symfony\Component\Form\FormBuilderInterface;
// Creará el botón Submit
use Symfony\Component\Form\Extension\Core\Type\SubmitType;

// El nombre de la clase debe ser el mismo del archivo
class CursosType extends AbstractType{
public function buildForm(FormBuilderInterface $builder, array $options)
    {
    // al objeto $builder le daremos forma añadiendo los campos del formulario
        $builder
            ->add('nombre')
            ->add('descripcion'))
            ->add('horas')
            // para cambiar la etiqueta añadimos el siguiente código array('label'=>'CrearCurso')
            ->add('save', SubmitType::class, array('label'=>'CrearCurso'));
    }
}
```
El siguiente paso consiste en incluir dentro del controlador el objeto de la clase, según la documentación sería así:

```php
// src/AppBundle/Controller/DefaultController.php
use AppBundle\Form\TaskType;

public function newAction()
{
    $task = ...;
    $form = $this->createForm(TaskType::class, $task);

    // ...
}
```

Para nuestro caso:

| src\Pixelpro\MisCursosBundle\Controller\DefaultController.php |
|---------------------------------------------------------------|

```php
<?php

namespace Pixelpro\MisCursosBundle\Controller;

// Cargamos el controlador por defecto
use Symfony\Bundle\FrameworkBundle\Controller\Controller;
// Cargamos el componente 'Request' que gestionará los envíos de datos a través de formularios mediante 'post'.
use Symfony\Component\HttpFoundation\Request;

// Es necesario pasar la clase del formulario
use Pixelpro\MisCursosBundle\Form\CursosType;
// Y el Entity que define la Base de Datos
use Pixelpro\MisCursosBundle\Entity\Cursos;

class DefaultController extends Controller
{
//método por defecto que se ejecuta al llamar a este controlador (indexAction)
    public function indexAction()
    {
    // llama a una vista que se llama por defecto index.html.twig
        return $this->render('PixelproMisCursosBundle:Default:index.html.twig');
    }
    public function mostrarAction($id)
    {
        return $this->render('PixelproMisCursosBundle:Default:mostrar.html.twig');
    }
    public function crearAction(Request $request)
    {
        // no son necesarias vistas
    }  
    public function nuevoAction()
    {
        // Primero isntanciamos el objeto Cursos ya definido dentro de la Clase del tipo Formulario
        $curso = new Cursos();
        /* 
         * Posteriormente creamos el objeto Form que contendrá la función 'createForm'
         * Para añadir parámetros incluimos un array dentro de la función 'createForm'
         * indicamos la 'action' la cual nos llevará a la vista generada dentro de 'routing.yml' 
         * del bundle denominada pixelpro_mis_cursos_crear
         * para finalizar añadiremos el método a usar para el envío de datos 'POST'
         */
        $form = $this->createForm(CursosType::class, $curso, array('action'=>$this->generateUrl('pixelpro_mis_cursos_crear'), 'method'=>'POST'));
        /*
            dentro de la vista habrá que enviar el formulario con sus distintas opciones usando un array 
        */
        return $this->render('PixelproMisCursosBundle:Default:nuevo.html.twig', array('form'=>$form->createView()));
    } 
    public function editarAction($id)
    {
        return $this->render('PixelproMisCursosBundle:Default:editar.html.twig');
    }
    public function actualizarAction(Request $request, $id)
    {
        // no son necesarias vistas
    }   
    public function eliminarAction(Request $request, $id)
    {
        // no son necesarias vistas
    }     
}
```

Ahora modificamos la vista para que se imprima en pantalla el formulario:

| src\Pixelpro\MisCursosBundle\Resources\views\Default\nuevo.html.twig |
|----------------------------------------------------------------------|

```twig
Vista para nuevos cursos
# Usaremos la siguiente forma para validar el controlador
# {{form(form)}}
# Para eliminar la opción de validar usaremos el siguiente código activo
{{form(form, {attr: {novalidate: 'novalidate'}})}}
```

Si introducimos la url `127.0.0.1:8000/nuevo` previo inicio del servidor mediante el comando de consola `php bin/console server:run`, veremos el formulario ya creado.

3.2.Introducir contenido en la Base de Datos
--------------------------------------------

El siguiente paso consiste en enviar e introducir el contenido del formulario en su correspondiente registro de la base de datos.

Para ello habrá que completar el método `public function crearAction(){}` del controlador `src\Pixelpro\MisCursosBundle\Controller\DefaultController.php` que gestiona la aplicación **MisCursos** del Bundle **Pixelpro** creado anteriormente.

| src\Pixelpro\MisCursosBundle\Controller\DefaultController.php |
|---------------------------------------------------------------|

```php
<?php

namespace Pixelpro\MisCursosBundle\Controller;

// Cargamos el controlador por defecto
use Symfony\Bundle\FrameworkBundle\Controller\Controller;
// Cargamos el componente 'Request' que gestionará los envíos de datos a través de formularios mediante 'post'.
use Symfony\Component\HttpFoundation\Request;

// Es necesario pasar la clase del formulario
use Pixelpro\MisCursosBundle\Form\CursosType;
// Y el Entity que define la Base de Datos
use Pixelpro\MisCursosBundle\Entity\Cursos;

class DefaultController extends Controller
{
//método por defecto que se ejecuta al llamar a este controlador (indexAction)
    public function indexAction()
    {
    // llama a una vista que se llama por defecto index.html.twig
        return $this->render('PixelproMisCursosBundle:Default:index.html.twig');
    }
    public function mostrarAction($id)
    {
        return $this->render('PixelproMisCursosBundle:Default:mostrar.html.twig');
    }
    public function crearAction(Request $request)
    {
        $curso = new Cursos();
        $form = $this->createForm(
            CursosType::class, 
            $curso, 
            array('action'=>$this->generateUrl('pixelpro_mis_cursos_crear'), 'method'=>'POST'));
        // Usamos request para requerir la información enviada            
        $form->handlerequest($request);
        // Validamos el formulario viendo si se cumple el siguiente método isValid()
        if($form->isValid()){
            // Usamos EntityManager ($em)
            $em = $this->getDoctrine()->getmanager();
            // guardamos el objeto
            $em->persist($curso);
            // para ejecutar la query usamos el método flush()
            $em->flush();
            // finalmente redirigimos a la vista 'pixelpro_mis_cursos_nuevo'
            return $this->redirect($this->generateUrl('pixelpro_mis_cursos_nuevo'));
        }
        // si no se cumple la condición pasamos la vista de nuevas
        return $this->render(
            'PixelproMisCursosBundle:Default:nuevo.html.twig', 
            array('form'=>$form->createView())
            );
    }  
    public function nuevoAction()
    {
        // Primero instanciamos el objeto Cursos ya definido dentro de la Clase del tipo Formulario
        $curso = new Cursos();
        /*
         * Posteriormente creamos el objeto Form que contendrá la función 'createForm'
         * Para añadir parámetros incluimos un array dentro de la función 'createForm'
         * indicamos la 'action' la cual nos llevará a la vista generada dentro de 'routing.yml' 
         * del bundle denominada pixelpro_mis_cursos_crear
         * para finalizar añadiremos el método a usar para el envío de datos 'POST'
         */
        $form = $this->createForm(
            CursosType::class, 
            $curso, 
            array('action'=>$this->generateUrl('pixelpro_mis_cursos_crear'), 'method'=>'POST'));
        // dentro de la vista habrá que enviar el formulario con sus distintas opciones usando un array            
        return $this->render(
            'PixelproMisCursosBundle:Default:nuevo.html.twig', 
            array('form'=>$form->createView())
            );
    } 
    public function editarAction($id)
    {
        return $this->render('PixelproMisCursosBundle:Default:editar.html.twig');
    }
    public function actualizarAction(Request $request, $id)
    {
        // no son necesarias vistas
    }   
    public function eliminarAction(Request $request, $id)
    {
        // no son necesarias vistas
    }     
}
```

--------------------------------------------

*Nota*: Se recomienda cada cierto tiempo actualizar la base de datos mediante el comando de consola `php bin/console doctrine:schema:update --force`, tras lo cual habrá que volver a iniciar el servidor.

--------------------------------------------

3.3.Mensajes Flash
------------------

Para acceder a la documentación relativa a los [Mensajes Flash en Symfony](https://symfony.com/doc/current/components/http_foundation/) accedemos al componente [http Foundation](https://symfony.com/doc/current/components/http_foundation/) en el apartado de manejo de sesiones [Session management](https://symfony.com/doc/current/components/http_foundation/sessions.html). Así usaremos el método `getFlashBag` el cual generará los mensajes con las notificaciones del formulario.

Usaremos la siguiente línea:

```php
/* Inicio de extracto de código */
        // Usamos el método 'getFlashBack para crear las notificaciones
        // Usaremos 'notif' para identificar la notificación con ese nombre (podría usarse otro, por ejemplo 'notificacion')
        $this->get('session')->getFlashBack()->add('notif', '¡El curso no se ha creado correctamente!');
/* Fin de extracto de código */
```

Ver código aplicado en el documento a continuación.

| src\Pixelpro\MisCursosBundle\Controller\DefaultController.php |
|---------------------------------------------------------------|

```php
<?php

namespace Pixelpro\MisCursosBundle\Controller;

// Cargamos el controlador por defecto
use Symfony\Bundle\FrameworkBundle\Controller\Controller;
// Cargamos el componente 'Request' que gestionará los envíos de datos a través de formularios mediante 'post'.
use Symfony\Component\HttpFoundation\Request;

// Es necesario pasar la clase del formulario
use Pixelpro\MisCursosBundle\Form\CursosType;
// Y el Entity que define la Base de Datos
use Pixelpro\MisCursosBundle\Entity\Cursos;

class DefaultController extends Controller
{
//método por defecto que se ejecuta al llamar a este controlador (indexAction)
    public function indexAction()
    {
    // llama a una vista que se llama por defecto index.html.twig
        return $this->render('PixelproMisCursosBundle:Default:index.html.twig');
    }
    public function mostrarAction($id)
    {
        return $this->render('PixelproMisCursosBundle:Default:mostrar.html.twig');
    }
    public function crearAction(Request $request)
    {
        $curso = new Cursos();
        $form = $this->createForm(
            CursosType::class, 
            $curso, 
            array('action'=>$this->generateUrl('pixelpro_mis_cursos_crear'), 'method'=>'POST'));
        // Usamos request para requerir la información enviada            
        $form->handlerequest($request);
        // Validamos el formulario viendo si se cumple el siguiente método isValid()
        if($form->isValid()){
            // Usamos EntityManager ($em)
            $em = $this->getDoctrine()->getmanager();
            // guardamos el objeto
            $em->persist($curso);
            // para ejecutar la query usamos el método flush()
            $em->flush();
            // Usamos el método 'getFlashBack para crear las notificaciones
            $this->get('session')->getFlashBag()->add('notif', '¡Curso creado correctamente!');
            // finalmente redirigimos a la vista 'pixelpro_mis_cursos_nuevo'
            return $this->redirect($this->generateUrl('pixelpro_mis_cursos_nuevo'));
        }
        // Usamos el método 'getFlashBack para crear las notificaciones
        $this->get('session')->getFlashBag()->add('notif', '¡El curso no se ha creado correctamente!');
        // si no se cumple la condición pasamos la vista de nuevas
        return $this->render(
            'PixelproMisCursosBundle:Default:nuevo.html.twig', 
            array('form'=>$form->createView())
            );
    }  
    public function nuevoAction()
    {
        // Primero instanciamos el objeto Cursos ya definido dentro de la Clase del tipo Formulario
        $curso = new Cursos();
        /*
         * Posteriormente creamos el objeto Form que contendrá la función 'createForm'
         * Para añadir parámetros incluimos un array dentro de la función 'createForm'
         * indicamos la 'action' la cual nos llevará a la vista generada dentro de 'routing.yml' 
         * del bundle denominada pixelpro_mis_cursos_crear
         * para finalizar añadiremos el método a usar para el envío de datos 'POST'
         */
        $form = $this->createForm(
            CursosType::class, 
            $curso, 
            array('action'=>$this->generateUrl('pixelpro_mis_cursos_crear'), 'method'=>'POST'));
        // dentro de la vista habrá que enviar el formulario con sus distintas opciones usando un array            
        return $this->render(
            'PixelproMisCursosBundle:Default:nuevo.html.twig', 
            array('form'=>$form->createView())
            );
    } 
    public function editarAction($id)
    {
        return $this->render('PixelproMisCursosBundle:Default:editar.html.twig');
    }
    public function actualizarAction(Request $request, $id)
    {
        // no son necesarias vistas
    }   
    public function eliminarAction(Request $request, $id)
    {
        // no son necesarias vistas
    }     
}
```

---------------------------------------------------------
El siguiente punto sería tratar la vista para que muestre la notifcación. Hay que tener en cuenta que **Symfony** tiene creada una base de vistas que permite ser modificada y que se encuentra en `app\Resources\views\base.html.twig`.


| app\Resources\views\base.html.twig |
|------------------------------------|

```twig
<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>{% block title %}Welcome!{% endblock %}</title>
        {% block stylesheets %}{% endblock %}
        <link rel="icon" type="image/x-icon" href="{{ asset('favicon.ico') }}" />
    </head>
    <body>
    <!-- Inicio del Bucle
    Con el siguiente bucle conseguimos que cuando entremos en la plantilla 
    por primera vez no muestre ninguna notificación, en cambio si es la segunda 
    vez o más que entramos mostrará notificaciones -->
        {% for flasMessage in app.session.flashbag.get('notif') %}
            <div> {{ flashMessage }} </div>
        {% endfor %}
    <!-- Fin del Bucle -->
            {% block body %}{% endblock %}
            {% block javascripts %}{% endblock %}
    </body>
</html>
```

para incluir dentro de la vista `src\Pixelpro\MisCursosBundle\Resources\views\Default\nuevo.html.twig` incluimos el siguiente código `{% extends 'base.html.twig' %} ` para que quede el archivo así:

| src\Pixelpro\MisCursosBundle\Resources\views\Default\nuevo.html.twig |
|----------------------------------------------------------------------|

```twig
# Extiendo la vista con el siguiente código
{% extends 'base.html.twig' %} 
# Añado el contenido dentro de body encerrandolo entre las dos etiquetas {% block body %}{% endblock %}
    {% block body %}
        <h2> Nuevo curos </h2>
        {{form(form, {attr: {novalidate: 'novalidate'}})}}
    {% endblock %}   
```

---------------------------------------------------------
